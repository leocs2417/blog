<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<script src="//cdn.bootcss.com/pace/1.0.2/pace.min.js"></script>
<link href="//cdn.bootcss.com/pace/1.0.2/themes/pink/pace-theme-flash.css" rel="stylesheet">
<style>
    .pace .pace-progress {
        background: #1E92FB; /*进度条颜色*/
        height: 2px;
    }
    .pace .pace-progress-inner {
         box-shadow: 0 0 10px #1E92FB, 0 0 5px     #1E92FB; /*阴影颜色*/
    }
    .pace .pace-activity {
        border-top-color: #1E92FB;    /*上边框颜色*/
        border-left-color: #1E92FB;    /*左边框颜色*/
    }
</style>
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 3.9.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=7.4.2">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=7.4.2">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=7.4.2">
  <link rel="mask-icon" href="/images/logo.svg?v=7.4.2" color="#222">

<link rel="stylesheet" href="/css/main.css?v=7.4.2">

<link rel="stylesheet" href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext">
<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css?v=4.7.0">


<script id="hexo-configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Gemini',
    version: '7.4.2',
    exturl: false,
    sidebar: {"position":"left","display":"post","offset":12,"onmobile":true},
    copycode: {"enable":true,"show_result":true,"style":"flat"},
    back2top: {"enable":true,"sidebar":false,"scrollpercent":true},
    bookmark: {"enable":false,"color":"#222","save":"auto"},
    fancybox: false,
    mediumzoom: false,
    lazyload: false,
    pangu: false,
    algolia: {
      appID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    },
    localsearch: {"enable":"auto","trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},
    path: 'search.xml',
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    translation: {
      copy_button: '复制',
      copy_success: '复制成功',
      copy_failure: '复制失败'
    },
    sidebarPadding: 40
  };
</script>

  <meta name="description" content="Redux本身其实只是单纯的状态管理库, 不跟任何界面UI相关.  我们先从基本的用法入手, 然后尝试使用手动实现一个简易的Redux.">
<meta name="keywords" content="JS,React">
<meta property="og:type" content="article">
<meta property="og:title" content="通过手写一个简单的Redux, 了解实现原理">
<meta property="og:url" content="http://yoursite.com/2020/05/07/通过手写Redux, 了解实现原理/index.html">
<meta property="og:site_name" content="Leo Chen&#39;s Blog">
<meta property="og:description" content="Redux本身其实只是单纯的状态管理库, 不跟任何界面UI相关.  我们先从基本的用法入手, 然后尝试使用手动实现一个简易的Redux.">
<meta property="og:locale" content="zh-CN">
<meta property="og:updated_time" content="2024-07-08T11:21:57.817Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="通过手写一个简单的Redux, 了解实现原理">
<meta name="twitter:description" content="Redux本身其实只是单纯的状态管理库, 不跟任何界面UI相关.  我们先从基本的用法入手, 然后尝试使用手动实现一个简易的Redux.">

<link rel="canonical" href="http://yoursite.com/2020/05/07/通过手写Redux, 了解实现原理/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome: false,
    isPost: true,
    isPage: false,
    isArchive: false
  };
</script>

  <title>通过手写一个简单的Redux, 了解实现原理 | Leo Chen's Blog</title>
  








  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-meta">

    <div>
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Leo Chen's Blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
        <p class="site-subtitle">一叶浮萍归大海，人生何处不相逢。</p>
  </div>

  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>
</div>


<nav class="site-nav">
  
  <ul id="menu" class="menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-fw fa-home"></i>首页</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-fw fa-tags"></i>标签</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>

</nav>
  <div class="site-search">
    <div class="popup search-popup">
    <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocorrect="off" autocapitalize="none"
           placeholder="搜索..." spellcheck="false"
           type="text" id="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result"></div>

</div>
<div class="search-pop-overlay"></div>

  </div>
</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content">
            

  <div class="posts-expand">
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block " lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/05/07/通过手写Redux, 了解实现原理/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/img/avatar.jpeg">
      <meta itemprop="name" content="Leo Chen">
      <meta itemprop="description" content="Not perfect, so need to learn.">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Leo Chen's Blog">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          通过手写一个简单的Redux, 了解实现原理
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/React/" itemprop="url" rel="index">
                    <span itemprop="name">React</span>
                  </a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <blockquote>
<p>Redux本身其实只是单纯的状态管理库, 不跟任何界面UI相关.</p>
</blockquote>
<p>我们先从基本的用法入手, 然后尝试使用手动实现一个简易的Redux.</p>
<a id="more"></a>

<h2 id="基本概念"><a href="#基本概念" class="headerlink" title="基本概念:"></a>基本概念:</h2><p>(来自Redux 中文网)<br>Redux是针对<code>JavaScript</code>应用程序的可预测状态容器.</p>
<p>它可以帮助您编写性能一致、在不同环境（客户端、服务器和原生环境）中运行且易于测试的应用程序.最重要的是, 它提供了出色的开发人员体验, 例如 带有时间旅行调试器的实时代码编辑.</p>
<p>可以将<code>Redux</code> 与<code>React</code>或任何其他类似的工具库一起使用. 他的体积很小（算上依赖也只有 2kB, 但是在其生态系统中有大量插件可用.</p>
<h3 id="如何使用"><a href="#如何使用" class="headerlink" title="如何使用:"></a>如何使用:</h3><p>Redux在使用层面上, 主要分三个部分: <code>Store</code>, <code>Actions</code>, <code>Reducers</code>.</p>
<h4 id="Store"><a href="#Store" class="headerlink" title="Store"></a>Store</h4><ul>
<li>用途: 存储(State)状态的仓库, 和一些操作状态的API, 使用用例: 初始化一个累加器的状态.</li>
</ul>
<h4 id="Actions"><a href="#Actions" class="headerlink" title="Actions"></a>Actions</h4><ul>
<li>用途: 改变Store中的某个状态, 使用用例: 想在num上, 进行加操作.</li>
</ul>
<h4 id="Reducers"><a href="#Reducers" class="headerlink" title="Reducers"></a>Reducers</h4><ul>
<li>用途: 上边的State中, 只是<strong>想</strong>添加一项item, 实际操作要使用Reducer: 根据接收的action参数, 来改变Store中的状态</li>
</ul>
<h4 id="整合简单实例"><a href="#整合简单实例" class="headerlink" title="整合简单实例:"></a>整合简单实例:</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Reducer 部分</span></span><br><span class="line"><span class="keyword">const</span> defaultState = &#123;</span><br><span class="line">	num: <span class="number">0</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> reducer = <span class="function">(<span class="params">state = defaultState, action</span>) =&gt;</span> &#123;</span><br><span class="line">	<span class="keyword">switch</span>(action.type) &#123;</span><br><span class="line">		<span class="keyword">case</span> <span class="string">'ADD_NUM'</span>:</span><br><span class="line">			<span class="keyword">return</span> &#123; ...state, <span class="attr">num</span>: state.num + action.count &#125;;</span><br><span class="line">		<span class="keyword">default</span>:</span><br><span class="line">			<span class="keyword">return</span> state;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Store 部分</span></span><br><span class="line"><span class="keyword">import</span> &#123; createStore &#125; <span class="keyword">from</span> <span class="string">'redux'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; reducer &#125; <span class="keyword">from</span> <span class="string">'./reducer'</span>;</span><br><span class="line"><span class="keyword">const</span> store = createStore(reducer);</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> store;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 某个使用`num`的组件</span></span><br><span class="line"><span class="keyword">import</span> &#123; store &#125; <span class="keyword">from</span> <span class="string">'./store'</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// subscribe: 订阅状态改变</span></span><br><span class="line"><span class="comment">// 一旦store发生了变化, 传入的回调函数就会被调用</span></span><br><span class="line"><span class="comment">// 页面UI的更新操作, 就是在这里执行的</span></span><br><span class="line"><span class="comment">// getState: 返回当前的state</span></span><br><span class="line">store.subscribe(<span class="function"><span class="params">()</span> =&gt;</span> <span class="built_in">console</span>.log(store.getState()));</span><br><span class="line"></span><br><span class="line"><span class="comment">// dispatch: 分发状态改变的动作</span></span><br><span class="line"><span class="keyword">const</span> action = &#123; <span class="attr">type</span>: <span class="string">'ADD_NUM'</span>, <span class="attr">count</span>: <span class="number">2</span> &#125;;</span><br><span class="line">store.dispatch(action);</span><br></pre></td></tr></table></figure>

<p>以上代码片段: 就是<strong>使用</strong>Redux, 实现对变量<code>num</code>的加操作.</p>
<h3 id="实现一个简单的Redux"><a href="#实现一个简单的Redux" class="headerlink" title="实现一个简单的Redux"></a>实现一个简单的Redux</h3><h4 id="createStore"><a href="#createStore" class="headerlink" title="createStore"></a>createStore</h4><p>用途: 接收reducer方法作为参数, 然后返回一个Store对象.</p>
<p>核心: 发布订阅模式</p>
<ul>
<li>关于Store主要用到的几个函数: <code>subscribe</code>, <code>dispatch</code>, <code>getState</code>.</li>
</ul>
<p>代码: </p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> createStore = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">	<span class="comment">// state记录所有状态</span></span><br><span class="line">  <span class="keyword">let</span> state;              </span><br><span class="line">	<span class="comment">// 保存所有注册的回调</span></span><br><span class="line">  <span class="keyword">let</span> listeners = [];</span><br><span class="line"></span><br><span class="line">	<span class="comment">// subscribe: 保存传进来的回调函数</span></span><br><span class="line">  <span class="keyword">const</span> subscribe = <span class="function">(<span class="params">callback</span>) =&gt;</span> &#123;</span><br><span class="line">    listeners.push(callback);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// dispatch: 就是将所有的回调拿出来依次执行就行</span></span><br><span class="line">  <span class="keyword">const</span> dispatch = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; listeners.length; i++) &#123;</span><br><span class="line">      <span class="keyword">const</span> listener = listeners[i];</span><br><span class="line">      listener();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// getState: 直接返回当前的state</span></span><br><span class="line">  <span class="keyword">const</span> getState = (state);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// store: 集合相关函数并导出</span></span><br><span class="line">  <span class="keyword">const</span> store = &#123;</span><br><span class="line">    subscribe,</span><br><span class="line">    dispatch,</span><br><span class="line">    getState</span><br><span class="line">  &#125;</span><br><span class="line">	<span class="comment">// ... 一些错误处理</span></span><br><span class="line">  <span class="keyword">return</span> store;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="combineReducers"><a href="#combineReducers" class="headerlink" title="combineReducers"></a>combineReducers</h4><p>用途: 顾名思义(Combined Reducers)组合Reducers, 当我们项目相对复杂后, 如果将所有逻辑都写在一个reducer里面, 会变得特别冗余, 这种情况下, 可以使用combineReducers这个API, 来模块化的编写多个reducer, 最后组合起来.</p>
<p>用法:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; createStore, combineReducers &#125; <span class="keyword">from</span> <span class="string">'redux'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> defaultNum = &#123;</span><br><span class="line">	num: <span class="number">0</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> numReducer = <span class="function">(<span class="params">state = defaultNum, action</span>) =&gt;</span> &#123;</span><br><span class="line">	<span class="keyword">switch</span>(action.type) &#123;</span><br><span class="line">		<span class="keyword">case</span> <span class="string">'ADD_NUM'</span>:</span><br><span class="line">			<span class="keyword">return</span> &#123; ...state, <span class="attr">num</span>: state.num + action.count &#125;;</span><br><span class="line">		<span class="keyword">case</span> <span class="string">'DECREASE_NUM'</span>:</span><br><span class="line">			<span class="keyword">return</span> &#123; ...state, <span class="attr">num</span>: state.num - action.count &#125;;</span><br><span class="line">		<span class="keyword">default</span>:</span><br><span class="line">			<span class="keyword">return</span> state;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> defaultTheme = &#123;</span><br><span class="line">  color: <span class="string">'red'</span>,</span><br><span class="line">	fontSize: <span class="number">16</span></span><br><span class="line">&#125;;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">themeReducer</span>(<span class="params">state = defaultTheme, action</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">switch</span> (action.type) &#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="string">'SET_THEME'</span>:</span><br><span class="line">      <span class="keyword">return</span> &#123; ...state, <span class="attr">color</span>: action.color &#125;;</span><br><span class="line">		<span class="keyword">case</span> <span class="string">'SET_FONTSIZE'</span>:</span><br><span class="line">			<span class="keyword">return</span> &#123; ...state, <span class="attr">fontSize</span>: action.fontSize &#125;;</span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">      <span class="keyword">return</span> state;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 组合reducer</span></span><br><span class="line"><span class="keyword">const</span> reducer = combineReducers(&#123; <span class="attr">numState</span>: numReducer, <span class="attr">themeState</span>: themeReducer &#125;);</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> store = createStore(reducer);</span><br><span class="line"></span><br><span class="line">store.subscribe(<span class="function"><span class="params">()</span> =&gt;</span> <span class="built_in">console</span>.log(store.getState()));</span><br><span class="line"></span><br><span class="line"><span class="comment">// 操作num的action</span></span><br><span class="line">store.dispatch(&#123; <span class="attr">type</span>: <span class="string">'ADD_NUM'</span>, <span class="attr">count</span>: <span class="number">1</span> &#125;);</span><br><span class="line">store.dispatch(&#123; <span class="attr">type</span>: <span class="string">'DECREASE_NUM'</span>, <span class="attr">count</span>: <span class="number">2</span> &#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 操作theme的action</span></span><br><span class="line">store.dispatch(&#123; <span class="attr">type</span>: <span class="string">'SET_THEME'</span>, <span class="attr">color</span>: <span class="string">'green'</span> &#125;);</span><br><span class="line">store.dispatch(&#123; <span class="attr">type</span>: <span class="string">'SET_FONTSIZE'</span>, <span class="attr">fontSize</span>: <span class="number">18</span> &#125;);</span><br></pre></td></tr></table></figure>

<p>代码: </p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> combineReducers = <span class="function">(<span class="params">reducerMap</span>) =&gt;</span> &#123;</span><br><span class="line">	<span class="comment">// 先把参数里面所有的键值拿出来</span></span><br><span class="line">  <span class="keyword">const</span> reducerKeys = <span class="built_in">Object</span>.keys(reducerMap);</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// 返回值是一个普通结构的reducer函数</span></span><br><span class="line">  <span class="keyword">const</span> reducers = <span class="function">(<span class="params">state = &#123;&#125;, action</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> newState = &#123;&#125;;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">let</span> key <span class="keyword">of</span> reducerKeys) &#123;</span><br><span class="line">      <span class="comment">// reducerKeys[i]: 对应每个reducer</span></span><br><span class="line">      <span class="comment">// 组合成reducer新的State: newState[key]集合</span></span><br><span class="line">      <span class="keyword">const</span> currentReducer = reducerMap[key];</span><br><span class="line">      <span class="keyword">const</span> prevState = state[key];</span><br><span class="line">      newState[key] = currentReducer(prevState, action);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> newState;</span><br><span class="line">  &#125;;</span><br><span class="line">  <span class="comment">// ... 一些错误处理</span></span><br><span class="line">  <span class="keyword">return</span> reducers;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="拓展-Redux-功能"><a href="#拓展-Redux-功能" class="headerlink" title="拓展 Redux 功能"></a>拓展 Redux 功能</h3><p>大多数的应用都会使用<code>middleware</code>或<code>enhancer</code>来拓展 Redux store 的功能.（注：middleware 很常见, enhancer 不太常见） middleware 拓展了 Redux dispatch 函数的功能；enhancer 拓展了 Redux store 的功能.</p>
<p>我们将会添加如下两个 middleware 和 一个 enhancer：</p>
<p>redux-thunk middleware, 允许了简单的 dispatch 异步用法.<br>一个记录 dispatch 的 action 和得到的新 state 的 middleware.<br>一个记录 reducer 处理每个 action 所用时间的 enhancer.</p>
<h4 id="applyMiddleware"><a href="#applyMiddleware" class="headerlink" title="applyMiddleware"></a>applyMiddleware</h4><p>用途: 中间件是Redudx生态中较重要的一个概念, <code>applyMiddleware</code>就是用来引入相关的中间件的.</p>
<p>用法:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// logger是一个中间件, 注意返回值嵌了好几层函数</span></span><br><span class="line"><span class="comment">// 我们后面来看看为什么这么设计</span></span><br><span class="line"><span class="keyword">const</span> logger = <span class="function"><span class="params">store</span> =&gt;</span> <span class="function"><span class="params">next</span> =&gt;</span> <span class="function"><span class="params">action</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="built_in">console</span>.group(action.type)</span><br><span class="line">  <span class="built_in">console</span>.info(<span class="string">'dispatching'</span>, action)</span><br><span class="line">  <span class="keyword">let</span> result = next(action)</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'next state'</span>, store.getState())</span><br><span class="line">  <span class="built_in">console</span>.groupEnd()</span><br><span class="line">  <span class="keyword">return</span> result</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> logger</span><br><span class="line"></span><br><span class="line"><span class="comment">// 调用createStore时, 将applyMiddleware作为第二个参数传进去</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> store = createStore(reducer, applyMiddleware(logger));</span><br></pre></td></tr></table></figure>

<p>可以看到上述代码为了支持中间件, createStore传入了第二个参数, 这个参数官方称为enhancer, 顾名思义他是一个增强器, 用来增强store的能力的.官方对于enhancer的定义如下：</p>
<p><code>type StoreEnhancer = (next: StoreCreator) =&gt; StoreCreator</code></p>
<p>上面的结构的意思是说enhancer作为一个函数, 传进来一个参数StoreCreator, 同时return的也是一个StoreCreator相同结构的函数.</p>
<h4 id="使createStore支持enhancer"><a href="#使createStore支持enhancer" class="headerlink" title="使createStore支持enhancer"></a>使createStore支持enhancer</h4><p>代码:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> createStore = <span class="function">(<span class="params">reducer, enhancer</span>) =&gt;</span> &#123;   <span class="comment">// 接收第二个参数enhancer</span></span><br><span class="line">  <span class="comment">// 先处理enhancer</span></span><br><span class="line">  <span class="comment">// 如果enhancer存在并且是函数</span></span><br><span class="line">  <span class="comment">// 我们将createStore作为参数传给他</span></span><br><span class="line">  <span class="comment">// 应该返回一个新的createStore</span></span><br><span class="line">  <span class="comment">// 我再拿这个新的createStore执行, 应该得到一个store</span></span><br><span class="line">  <span class="comment">// 最后返回这个store</span></span><br><span class="line">  <span class="keyword">if</span>(enhancer &amp;&amp; <span class="keyword">typeof</span> enhancer === <span class="string">'function'</span>)&#123;</span><br><span class="line">    <span class="keyword">const</span> newCreateStore = enhancer(createStore);</span><br><span class="line">    <span class="keyword">const</span> newStore = newCreateStore(reducer);</span><br><span class="line">    <span class="keyword">return</span> newStore;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// 如果没有enhancer或者enhancer不是函数, 直接执行之前的逻辑</span></span><br><span class="line">  <span class="comment">// .......</span></span><br><span class="line">  <span class="keyword">const</span> store = &#123;</span><br><span class="line">    subscribe,</span><br><span class="line">    dispatch,</span><br><span class="line">    getState</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> store;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> createStore;</span><br></pre></td></tr></table></figure>

<h4 id="applyMiddleware-1"><a href="#applyMiddleware-1" class="headerlink" title="applyMiddleware"></a>applyMiddleware</h4><p>前面我们已经有了enhancer的基本结构, applyMiddleware是作为第二个参数传给createStore的, 也就是说他是一个enhancer, 准确的说是applyMiddleware的返回值是一个enhancer, 因为我们传给createStore的是他的执行结果applyMiddleware():</p>
<p>一个中间件的具体结构:</p>
<ul>
<li>一个中间件接收store作为参数, 会返回一个函数</li>
<li>返回的这个函数接收老的dispatch函数作为参数, 会返回一个新的函数</li>
<li>返回的新函数就是新的dispatch函数, 这个函数里面可以拿到外面两层传进来的store和老dispatch函数</li>
</ul>
<p>代码:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> applyMiddleware = <span class="function">(<span class="params">middleware</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> enhancer = <span class="function">(<span class="params">createStore</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> newCreateStore = <span class="function">(<span class="params">reducer</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">const</span> store = createStore(reducer);</span><br><span class="line">      </span><br><span class="line">      <span class="comment">// 将middleware拿过来执行下, 传入store</span></span><br><span class="line">      <span class="comment">// 得到第一层函数</span></span><br><span class="line">      <span class="keyword">const</span> func = middleware(store);</span><br><span class="line">      </span><br><span class="line">      <span class="comment">// 解构出原始的dispatch</span></span><br><span class="line">      <span class="keyword">const</span> &#123; dispatch &#125; = store;</span><br><span class="line">      </span><br><span class="line">      <span class="comment">// 将原始的dispatch函数传给func执行</span></span><br><span class="line">      <span class="comment">// 得到增强版的dispatch</span></span><br><span class="line">      <span class="keyword">const</span> newDispatch = func(dispatch);</span><br><span class="line">      </span><br><span class="line">      <span class="comment">// 返回的时候用增强版的newDispatch替换原始的dispatch</span></span><br><span class="line">      <span class="keyword">return</span> &#123;...store, <span class="attr">dispatch</span>: newDispatch&#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> newCreateStore;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">return</span> enhancer;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> applyMiddleware;</span><br></pre></td></tr></table></figure>

<h4 id="多个中间件"><a href="#多个中间件" class="headerlink" title="多个中间件"></a>多个中间件</h4><p>示例:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">applyMiddleware(</span><br><span class="line">  rafScheduler,</span><br><span class="line">  timeoutScheduler,</span><br><span class="line">  thunk,</span><br><span class="line">  vanillaPromise,</span><br><span class="line">  readyStatePromise,</span><br><span class="line">  logger,</span><br><span class="line">  crashReporter</span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<p>返回的newDispatch里, 将传入的middleware依次的串行执行就行.<br>多个函数的串行执行可以使用辅助函数compose, 这个函数定义如下, 最终需返回一个包裹了所有方法的方法.</p>
<p>compose函数:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">compose</span>(<span class="params">...func</span>)</span>&#123;</span><br><span class="line">  <span class="keyword">return</span> funcs.reduce(<span class="function">(<span class="params">a, b</span>) =&gt;</span> <span class="function">(<span class="params">...args</span>) =&gt;</span> a(b(...args)));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>支持多个中间件的实现:</p>
<p>内部结构:</p>
<ol>
<li>enhancer: 接收传入的store</li>
<li>newCreateStore: dispatch =&gt; newDispatch, 多个中间件的这层函数可以compose起来, 形成一个大的dispatch =&gt; newDispatch</li>
<li>return {…store, dispatch: newDispatch}.</li>
</ol>
<p>代码:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 参数支持多个中间件</span></span><br><span class="line"><span class="keyword">const</span> applyMiddleware = <span class="function">(<span class="params">...middlewares</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> enhancer = <span class="function">(<span class="params">createStore</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> newCreateStore = <span class="function">(<span class="params">reducer</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">const</span> store = createStore(reducer);</span><br><span class="line">      </span><br><span class="line">      <span class="comment">// 多个middleware, 先解构出dispatch =&gt; newDispatch的结构</span></span><br><span class="line">      <span class="keyword">const</span> chain = middlewares.map(<span class="function"><span class="params">middleware</span> =&gt;</span> middleware(store));</span><br><span class="line">      <span class="keyword">const</span> &#123; dispatch &#125; = store;</span><br><span class="line">      </span><br><span class="line">      <span class="comment">// 用compose得到一个组合了所有newDispatch的函数</span></span><br><span class="line">      <span class="keyword">const</span> newDispatchGen = compose(...chain);</span><br><span class="line">      <span class="comment">// 得到newDispatch</span></span><br><span class="line">      <span class="keyword">const</span> newDispatch = newDispatchGen(dispatch);</span><br><span class="line"></span><br><span class="line">      <span class="keyword">return</span> &#123;...store, <span class="attr">dispatch</span>: newDispatch&#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> newCreateStore;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">return</span> enhancer;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> applyMiddleware;</span><br></pre></td></tr></table></figure>

<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><ul>
<li><p>Redux本身只是一个状态存储仓库(store).</p>
</li>
<li><p>store: 里面存了所有的状态(state).</p>
</li>
<li><p>改变state: 通过dispatch(action).</p>
</li>
<li><p>分发出去的action: 通过reducer来处理, 处理后得到并返回新的state.</p>
</li>
<li><p>subscribe: 订阅状态改变, 一旦store发生了变化, 传入的回调函数就会被调用.</p>
</li>
<li><p>enhancer: 其实就是一个装饰者模式, 传入当前的createStore, 返回一个增强的createStore.</p>
</li>
<li><p>可以使用<code>applyMiddleware</code>添加中间件, applyMiddleware的返回值就是一个enhancer. 中间件也是一个装饰者模式, 传入当前的dispatch, return一个enhancer的dispatch.</p>
</li>
<li><p>Redux只涉及数据层: 不涉及UI层.</p>
</li>
</ul>

    </div>

    
    
    

      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/JS/" rel="tag"> <i class="fa fa-tag"></i> JS</a>
              <a href="/tags/React/" rel="tag"> <i class="fa fa-tag"></i> React</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-next post-nav-item">
                <a href="/2020/03/30/Object.create()和{}的区别/" rel="next" title="Object.create和{}的区别">
                  <i class="fa fa-chevron-left"></i> Object.create和{}的区别
                </a>
            </div>

            <span class="post-nav-divider"></span>

            <div class="post-nav-prev post-nav-item">
                <a href="/2020/07/14/React Virtual DOM/" rel="prev" title="React Virtual DOM">
                  React Virtual DOM <i class="fa fa-chevron-right"></i>
                </a>
            </div>
          </div>
      </footer>
    
  </article>
  
  
  

  </div>


          </div>
          

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#基本概念"><span class="nav-number">1.</span> <span class="nav-text">基本概念:</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#如何使用"><span class="nav-number">1.1.</span> <span class="nav-text">如何使用:</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Store"><span class="nav-number">1.1.1.</span> <span class="nav-text">Store</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Actions"><span class="nav-number">1.1.2.</span> <span class="nav-text">Actions</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Reducers"><span class="nav-number">1.1.3.</span> <span class="nav-text">Reducers</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#整合简单实例"><span class="nav-number">1.1.4.</span> <span class="nav-text">整合简单实例:</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#实现一个简单的Redux"><span class="nav-number">1.2.</span> <span class="nav-text">实现一个简单的Redux</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#createStore"><span class="nav-number">1.2.1.</span> <span class="nav-text">createStore</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#combineReducers"><span class="nav-number">1.2.2.</span> <span class="nav-text">combineReducers</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#拓展-Redux-功能"><span class="nav-number">1.3.</span> <span class="nav-text">拓展 Redux 功能</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#applyMiddleware"><span class="nav-number">1.3.1.</span> <span class="nav-text">applyMiddleware</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#使createStore支持enhancer"><span class="nav-number">1.3.2.</span> <span class="nav-text">使createStore支持enhancer</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#applyMiddleware-1"><span class="nav-number">1.3.3.</span> <span class="nav-text">applyMiddleware</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#多个中间件"><span class="nav-number">1.3.4.</span> <span class="nav-text">多个中间件</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#总结"><span class="nav-number">2.</span> <span class="nav-text">总结</span></a></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <img class="site-author-image" itemprop="image" alt="Leo Chen"
    src="/img/avatar.jpeg">
  <p class="site-author-name" itemprop="name">Leo Chen</p>
  <div class="site-description" itemprop="description">Not perfect, so need to learn.</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives">
          <span class="site-state-item-count">18</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
        <span class="site-state-item-count">8</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">10</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/leocs2417" title="GitHub &rarr; https://github.com/leocs2417" rel="noopener" target="_blank"><i class="fa fa-fw fa-github"></i>GitHub</a>
      </span>
  </div>



      </div>
    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        
  <div class="beian"><a href="http://www.beian.miit.gov.cn" rel="noopener" target="_blank">辽ICP备17015710号 </a>
  </div>

<div class="copyright">
  
  &copy; 2017 – 
  <span itemprop="copyrightYear">2024</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Leo Chen</span>
</div>

        












        
      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js?v=3.1.0"></script>
  <script src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  <script src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
<script src="/js/utils.js?v=7.4.2"></script><script src="/js/motion.js?v=7.4.2"></script>
<script src="/js/schemes/pisces.js?v=7.4.2"></script>
<script src="/js/next-boot.js?v=7.4.2"></script>



  






  <script src="/js/local-search.js?v=7.4.2"></script>













  

  

  


</body>
</html>
